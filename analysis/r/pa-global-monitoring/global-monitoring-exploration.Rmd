---
title: "Global Monitoring Exploration: Displacement Data"
author: "Seth Caldwell"
date: "2022-07-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})

source(here::here("exploration.R"))
```

This document quickly highlights the exploration done on displacement data for
CERF global monitoring.

## Normalization

The first thing noticed about the data was that displacement events cover a wide
range of days. Many cover only a single day, however, there are many events recording
displacements across a much larger time period.


```{r histogram-days}
df_clean_time %>%
  transmute(
    days = difftime(end_date, start_date, units = "days")
  ) %>%
  ggplot(
    aes(
      x = days
    )
  ) +
  geom_bar(
    aes(
      y = (..count..)/sum(..count..)
    )
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  labs(
    y = "% of displacement events",
    x = "Length of event (days)",
    title = "Length of reported displacement events"
  )
```

So, even though around one third of the events are on a single day, nearly two
thirds last longer, with a wide range of values. The other issue is that the
displacement events overlap across countries and multiple events can occur on
the same date(s).

We need to standardize this in order to generate flags for outliers. Thus,
all reported displacement events were normalized to daily events, with displacement
numbers uniformly distributed across the days. Thus, 3,000 people displaced from
July 1 to July 3 in a country would instead be reported as 1,000 people for each
day.

Then, in each country, all displacement events on a specific day are normalized
to generate a daily displacement figure. In the end, we have a daily time series
for each country. This can then be used to generate flags for outliers or
when we want to alert CERF.

## Flagging

The general idea behind the flagging here was that there might not be a single
"outlier" that CERF would want to be alerted to. There might be long term
displacement crises that do not see particularly high values, but has very high
displacement across months or years. High daily displacement in one country
may not be particularly high elsewhere. New displacement after a period of time
without any might be important to flag, even if it isn't necessarily when action
needs to be taken if the displacement is small in size.

Thus, the following flags were calculated for exploration, and they are certainly
not comprehensive of everything that could be tried.

### Country-level time series outliers

- Daily displacement that is in the 95th percentile for a country
- Weekly displacement that is in the 95th percentile for a country
- Monthly displacement that is in the 95th percentile for a country
- Quarterly displacement that is in the 95th percentile for a country
- Yearly displacement that is in the 95th percentile for a country
- Time series outliers calculated based on trend calculation (forecast package)

### Global time series outliers

- Daily displacement that is in the 95th percentile globally
- Weekly displacement that is in the 95th percentile globally
- Monthly displacement that is in the 95th percentile globally
- Quarterly displacement that is in the 95th percentile globally
- Yearly displacement that is in the 95th percentile globally

### Set thresholds

Set thresholds can also be used, simply aligning a clean and standard number that
if above, flagging is done. The original numbers tested were generated by
finding clean, whole numbers that were not as high as the 95th percentile of
the global dataset, so that flagging would be more sensitive than the global
time series above. These could be adjusted based on normative ideas on when
action should be taken, analysis on when CERF has previously acted, or based on
more detailed analysis of the available displacement data.

- Daily displacement over 5,000 persons (95th percentile is `r round(flag_lim(df_flagged$daily))`)
- Weekly displacement over 20,000 persons (95th percentile is `r round(flag_lim(df_flagged$weekly))`)
- Monthly displacement over 100,000 persons (95th percentile is `r round(flag_lim(df_flagged$monthly))`)
- Quarterly displacement over 250,000 persons (95th percentile is `r flag_lim(df_flagged$quarterly)`)
- Yearly displacement over 500,000 persons (95th percentile is `r round(flag_lim(df_flagged$yearly))`)

### Flagging put together

Overall, putting the flags together, we can get a sense of when we might want to
be paying attention to a country. Looking at the first displacement in a year,
the the country-level percentile flags, and set thresholds together on a set of
example countries, we see the following.

```{r cum_plot, out.width = "95%", fig.height = 10, fig.width = 15}
p_cumulative
```

We can look at individual ones to see what is driving this, and plots for each
have been saved to the Global Monitoring folder. However, the argument here is
simply that allowing all flags to operate may be an easier and cleaner way to
create flags that then allow additional investigation by desk officers and
contextual experts to determine what actions should or should not be taken.