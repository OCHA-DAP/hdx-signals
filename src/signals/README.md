## Signals

Signals are generated by scanning datasets. All of the code for scanning those
datasets is stored in `src/indicators`. This repository contains the overall
workflow for converting indicator alerts into a signals dataset and emails.

For each indicator `update_{...}.R` script, `generate_signals()` (described below)
is the main function call. If any signals are detected, all campaign content,
templates, and draft Mailchimp campaigns are created, and the data saved out
to `output/{indicator_id}/signals.parquet`.

These are then reviewed manually before sending out, which can be done with
`triage_signals()`. If approved, then the data is removed from the staging
`output/{indicator_id}/signals.parquet` file and moved to the final Signals
dataset `ouput/signals.parquet` and pushed to HDX. The draft campaigns are
sent from Mailchimp.

If during triage the campaigns need to be fixed, then they can be deleted,
with all content on Mailchimp deleted using `delete_campaign_content()` and the
staged file on Azure being deleted. If nothing is specified, the campaigns are
not sent and the data remains staged for further action.

### [`generate_signals.R`](generate_signals.R)

The main function in the whole folder is `generate_signals()`.
The function is used in all `indicator` scripts
to generate signals when negative changes are detected, create visualisations with
`images` functions, emails from `email`, and using many of the utilities in `utils`.

### Support scripts

Most of the scripts in this folder are used in `generate_signals.R`.

- [`check_existing_signals.R`](check_existing_signals.R): Checks for existing
signals data for `indicator_id` and throws errors depending on run conditions.
- [`create_campaigns.R`](create_campaigns.R): Create template HTML file and then
campaigns in Mailchimp, using campaign content from `generate_campaign_content.R`.
- [`filter_alerts.R`](filter_alerts.R): Initial alerts data frames are always
created by `{indicator_id}/utils/alert_{...}.R`. This further filters signals based
on methods to ensure alerting is not too frequent for locations.
- [`filter_test_data.R`](filter_test_data.R): Filters data frames when testing.
- [`generate_alerts.R`](generate_alerts.R): Validates alerts, adds additional data
to the data frame, and filters it with `filter_alerts.R`.
- [`generate_campaign_content.R`](generate_campaign_content.R): Generates campaign
content, from plots and maps to the info and summary texts, which is then used
to generate campaigns with `create_campaigns.R`.
- [`template_data.R`](template_data.R): Template data frames that should be produced
in `generate_signals()`, used to validate outputs.

### Other scripts

Other scripts are involved in the signalling process, but are not solely related
to supporting `generate_signals.R`.

- [`check_signals_updates.R`](check_signals_updates.R): Checks workflows in
`.github` and reports the status of workflows and whether any signals were identified.
- [`delete_campaign_content.R`](delete_campaign_content.R): Delete campaign
content from data frame, looping through Mailchimp IDs and deleting them from
severs.
- [`triage_signals.R`](triage_signals.R): Triage signals and choose whether or
not to `APPROVE` and send, `DELETE` and fix errors, or do nothing and wait for
further action.
