---
title: "email"
output: blastula::blastula_email
---

<style type = "text/css">

h1, h2, h3 {
  font-family: Arvo, "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: normal
}

p {
  font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fontfamily = "Source Sans Pro",
  fig.cap = "",
  fig.path = file.path("figure", paste0(flag_source, "_", flag_type), "")
)

library(blastula)
library(purrr)
library(dplyr)
library(sf)
library(stringr)
library(gghdx)

# adding these calls because they are optional dependencies
# so removes renv warning
library(showtext)
library(showtextdb)
library(sysfonts)
gghdx()

source("email.R")

flag_source_str <- str_to_upper(flag_source)
flag_type_str <- str_replace(str_to_title(flag_type), "_", " ")

flags_specific <- filter(
  flags_email,
  flag_type == !!flag_type,
  flag_source == !!flag_source
)

# get list of country links for putting in first paragraphs
flags_specific$country_id <- str_replace(tolower(flags_specific$country), " ", "-")
countries_md <- paste0(
  "<a href=\"#",
  flags_specific$country_id,
  "\">",
  flags_specific$country,
  "</a>",
  collapse = ", "
)

# get the intro methods text based on the displacement type
flag_method <- case_when(
  flag_type == "displacement" ~ "abnormally high displacement data from the Internal Displacement Monitoring Centre (IDMC)",
  flag_type == "food_insecurity" ~ "estimated increase in populations of phase 3 and/or above from Integrated Food Security Phase Classification / Cadre HarmonisÃ© (IPC/CH) data"
)

# CERF dashboard link
cerf_link <- case_when(
  flag_type %in% c("displacement", "food_insecurity") ~ "[CERF global monitoring dashboard](https://app.powerbi.com/groups/2ecadc97-779b-45da-bc5a-f8917fbdc734/reports/a06761fe-5edb-43f4-9d28-b01c8d813a02/ReportSection?experience=power-bi)"
)
```


<!--Set the preview text of the email-->
<div style="display:none">`r paste(flags_specific$country, collapse = ", ")`</div>

```{r, results="asis"}
add_image(
  file = "centre_logo.png",
  alt = "Centre for Humanitarian Data logo",
  align = "left",
  width = "25%"
)
```


# Global Monitoring Alert

<div style="font-size:10px;padding: 6px 10px 6px 10px;background-color:#CCCCCC;color:#FFFFFF">
<p style="margin:0;">
The global monitoring alert system is managed by the OCHA Centre for Humanitarian Data in collaboration with the UN Central Emergency Response Fund in order to bring attention to changes in key indicators relevant to humanitarian response.
</p>
</div>

## `r flag_type_str`, `r gsub("^0", "", format(Sys.Date(), "%d %B %Y"))`

`r str_to_sentence(flag_type_str)` alerts have been flagged for
the following locations: `r countries_md`.

`r str_to_sentence(flag_type_str)`
alerts are generated base on `r flag_method`. Full documentation and
source code is available on 
[GitHub](https://github.com/OCHA-DAP/pa-global-monitoring/). See the
`r cerf_link` for more data, visualizations, and details on the alerts.

----

```{r, results = "asis"}

pwalk(
  .l = flags_specific %>%
    select(
      iso3,
      country,
      country_id,
      start_date,
      end_date,
      message,
      url,
      summary_experimental
    ),
  .f = \(
    iso3,
    country,
    country_id,
    start_date,
    end_date,
    message,
    url,
    summary_experimental
  ) {
    knitr::knit_child(
      "alert_section.Rmd",
      envir = environment(),
      quiet = TRUE
    ) |>
      cat()
  }
)
```

## Contact

Contact the OCHA Centre for Humanitarian Data via Leonardo Milano, Team Lead
for Data Science at leonardo.milano@un.org with any questions or feedback.

----

```{r}
add_image(
  file = "ocha_logo_wide.png",
  align = "center",
  width = "25%"
)
```

<p>
<center>

<b> OCHA Centre For Humanitarian Data </b>

Fluwelen Burgwal 58 | 2511 CJ The Hague | The Netherlands

</center>
</p>
