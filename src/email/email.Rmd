---
title: "email"
output: blastula::blastula_email
---

<style type = "text/css">

h1, h2, h3 {
  font-family: Arvo, "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: normal
}

p {
  font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fontfamily = "Source Sans Pro",
  fig.cap = "",
  fig.path = file.path("figure", paste0(flag_source, "_", flag_type), "")
)

library(blastula)
library(purrr)
library(dplyr)
library(sf)
library(stringr)
library(gghdx)
gghdx()

source("email.R")

flag_source_str <- str_to_upper(flag_source)
flag_type_str <- str_replace(str_to_title(flag_type), "_", " ")

flags_specific <- filter(
  flags_email,
  flag_type == !!flag_type,
  flag_source == !!flag_source
)

# get list of country links for putting in first paragraphs
flags_specific$country_id <- str_replace(tolower(flags_specific$country), " ", "-")
countries_md <- paste0(
  "<a href=\"#",
  flags_specific$country_id,
  "\">",
  flags_specific$country,
  "</a>",
  collapse = ", "
)

# get the intro methods text based on the displacement type
flag_method <- case_when(
  flag_type == "displacement" ~ "abnormally high displacement reported by the IDMC",
  flag_type == "food_security" ~ "estimated increase in populations of phase 3 above by the IPC/CH"
)

```


<!--Set the preview text of the email-->
<div style="display:none">`r paste(flags_specific$country, collapse = ", ")`</div>

```{r, results="asis"}
add_image(
  file = "centre_logo.png",
  alt = "Centre for Humanitarian Data logo",
  align = "left",
  width = "25%"
)
```


# Global Monitoring Alert

## `r flag_type_str` - `r flag_source_str` - `r gsub(" 0", " ", format(Sys.Date(), "%d %B %Y"))`

`r str_to_sentence(flag_type_str)` alerts have been flagged by the
OCHA Centre for Humanitarian Data (CHD) global monitoring alert system in
the following countries: `r countries_md`.

The global monitoring alert system has been developed by CHD in collaboration
with the Central Emergency Response Fund. `r str_to_sentence(flag_type_str)`
alerts are generated base on `r flag_method`. Full documentation and
source code is is available on [GitHub](https://github.com/OCHA-DAP/pa-global-monitoring/).

----

```{r, results = "asis"}

pwalk(
  .l = flags_specific %>%
    select(
      iso3,
      country,
      country_id,
      start_date,
      end_date,
      message,
      url,
      summary_experimental
    ),
  .f = \(
    iso3,
    country,
    country_id,
    start_date,
    end_date,
    message,
    url,
    summary_experimental
  ) {
    knitr::knit_child(
      "alert_section.Rmd",
      envir = environment(),
      quiet = TRUE
    ) |>
      cat()
  }
)
```

## Contact

Reach out to the CHD predictive analytics team lead
Leonardo Milano at leonardo.milano@un.org if you would like to discuss the
global monitoring alert system.

----

```{r}
add_image(
  file = "ocha_logo_wide.png",
  align = "center",
  width = "25%"
)
```

<p>
<center>

<b> OCHA Centre For Humanitarian Data </b>

Fluwelen Burgwal 58 | 2511 CJ The Hague | The Netherlands

</center>
</p>
